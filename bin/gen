#!/usr/bin/env ruby

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

# TODO: is this needed?
require "bundler/setup" # Set up gems listed in the Gemfile.

require 'redcarpet'
require_relative '../lib/generator.rb'
require_relative '../lib/file_locations.rb'

def traverse(dir, generator)
  Dir.each_child(File.join(FileLocations::Src, dir)) do |entry|
    child_path = File.join(dir, entry)
    abs_child_path = File.join(FileLocations::Src, child_path)

    dist_child_path = File.join(FileLocations::Dist, child_path)

    if Dir.exist?(abs_child_path)

      if not Dir.exist?(dist_child_path)
        Dir.mkdir(dist_child_path)
      end

      generator.gen_directory_index(dist_child_path, abs_child_path, child_path)
      traverse(child_path, generator)

    elsif File.exist?(abs_child_path) && File.readable?(abs_child_path)
      generator.gen_post(dist_child_path, abs_child_path, child_path)
    end
  end
end

markdown = Redcarpet::Markdown.new(Redcarpet::Render::HTML)

generator = Blog::Generator.new(markdown)

traverse('', generator)
